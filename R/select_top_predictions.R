#' Extract top NetworKIN predictions
#' 
#' The strongest NetworKIN predictions for each phosphosite are selected.
#' @param predictions_file `<character>` Filename of the  NetworKIN output file
#' @param phospho_cleaned_file `<character>` Filename of the cleaned phosphoproteomic file
#' generated by `networkin_input`.
#' @param output_folder `<character>` Where the output files should be stored
#' @import readr
#' @import dplyr
#' @importFrom magrittr "%>%" 
#' @export

select_top_predictions <- function(predictions_file = 'networKIN_output.tsv',
                            phospho_cleaned_file = 'phospho_clean.csv',
                              output_folder = 'data/'){
  predictions <- read_tsv(paste0(output_folder, predictions_file), col_types = cols()) %>%
    select(-`Target Name`,
           -`Kinase/Phosphatase/Phospho-binding domain description`,
           -`Kinase/Phosphatase/Phospho-binding domain Name`) %>%
    select("target_id" = substrate,
           "protein_name" = `Target description`,
           "phosphosite" = MOD_RSD,
           "kinase_phosphatase_phospho-binding" = `Kinase/Phosphatase/Phospho-binding domain`,
           "networkin_score" = `NetworKIN score`,
           "netphorest_probability" = `NetPhorest probability`,
           "family_tree" = Tree,
           "netphorest_group" = `NetPhorest Group`)
  predictions %<>%
    mutate(protein_phosphosite = str_c(target_id, phosphosite, sep = ":"))
  
  phospho <- read_csv(paste0(output_folder, phospho_cleaned_file), col_types = cols()) %>%
    mutate(protein_phosphosite = paste0(substrate, ":", str_extract(MOD_RSD, '[:alnum:]+')))
  top_predictions <- predictions %>%
    group_by(protein_phosphosite) %>%
    filter(near(networkin_score, max(networkin_score))) %>% #near() is safer than == (see ?near)
    select(protein_phosphosite, "top_predicted_kinase" = `kinase_phosphatase_phospho-binding`)
  phospho_predictions <- left_join(phospho, top_predictions, by = "protein_phosphosite")
  write_csv(phospho_predictions, paste0(output_folder, "top_predictions.csv"))
}
