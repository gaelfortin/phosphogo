#' Extract top NetworKIN predictions
#' 
#' The strongest NetworKIN predictions for each phosphosite are selected.
#' @param predictions_file `<character>` Location of the filtered NetworKIN output file
#' @param phospho_cleaned_file `<character>` Location of the cleaned phosphoproteomic file
#' generated by `networkin_input`.
#' @param experiment `<character>` Name of the experiment to tag output files
#' @import readr
#' @import dplyr
#' @importFrom magrittr "%>%" 
#' @export

select_top_predictions <- function(predictions_file = 'data/analyses/filtered_networkin_predictions.csv',
                            phospho_cleaned_file = 'data/outputs/phospho_clean.csv',
                              experiment = 'test'){
  predictions <- read_csv(predictions_file, col_types = cols())
  phospho <- read_csv(phospho_cleaned_file, col_types = cols()) %>%
    mutate(protein_phosphosite = paste0(substrate, ":", str_extract(MOD_RSD, '[:alnum:]+')))
  top_predictions <- predictions %>%
    group_by(protein_phosphosite) %>%
    filter(near(networkin_score, max(networkin_score))) %>% #near() is safer than == (see ?near)
    select(protein_phosphosite, "top_predicted_kinase" = `kinase_phosphatase_phospho-binding`)
  phospho_predictions <- left_join(phospho, top_predictions, by = "protein_phosphosite")
  write_csv(phospho_predictions, paste0("data/analyses/top_predictions_", experiment, ".csv"))
}
