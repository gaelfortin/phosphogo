---
title: "How to use phosphogo"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{How to use phosphogo}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This vignette highlights essential functions of `phosphogo` and their use.
For details on `phosphogo` installation, refer to the [GitHub repository](https://github.com/gaelfortin/phosphogo)
of `phosphogo`.


```{r setup}
library(phosphogo)
dir.create('data', showWarnings = FALSE) 
```

0. Install NetworKIN
```{r eval=FALSE}
networkin_setup()
```

1. Generate NetworKIN input from phosphoproteomic data
```{r eval=FALSE}
# Human phosphoproteomic data
networkin_input(
  phospho_file = "phospho_human.xlsx",
  phosphosites_column = "PhosphoSite",
  log2_column = "Log2",
  fdr_column = "Adj. Pvalue",
  species = 'hsa',
  output_folder = 'data/'
)

# Mouse phosphoproteomic data
networkin_input(
  phospho_file = "phospho_mouse.xlsx",
  phosphosites_column = "ProteinID-Phospho:Site",
  log2_column = "Log2",
  fdr_column = "Adj. Pvalue",
  species = 'mmu',
  output_folder = 'data/'
)
```

2. Run NetworKIN
__Does not work on Windows__
NetworKIN works with old versions of BLAST (i.e. before BLAST 2.2.18). 
Install Blast 2.2.17 at https://ftp.ncbi.nih.gov/blast/executables/legacy.NOTSUPPORTED/2.2.17/
NetworKIN requires Python 2.

```{r eval=FALSE}
run_networkin(
  input_file = "networKIN_input.res",
  blastall_location = "~/blast-2.2.17/bin/blastall",
  output_folder = "data/"
)
```

3. NetworKIN predictions filtering
Predictions that have a score in the top 20% of all predictions are kept. Predictions are kept for all sites (significantly deregulated or not deregulated).
```{r eval=FALSE}
filter_predictions(
  predictions_file = 'networKIN_output.tsv',
  output_folder = 'data/'
)
```

4. NetworKIN Fisher exact test
The following Fisher exact test can be performed with NetworKIN and IV-KEA:
- Up reg vs down reg
- Up reg vs everything (signif and not signif)
- Down reg vs everything (signif and not signif)
```{r eval=FALSE}
select_top_predictions(predictions_file = 'filtered_networkin_predictions.csv',
                phospho_cleaned_file = 'phospho_clean.csv',
                output_folder = 'data/')
perform_Fisher_exact_test(top_predictions_file = 'top_predictions.csv',
                              predictions = "networkin",
                              output_folder = "data/",
                              FC_threshold = 1.2) 
```

5. Generate volcano plots
Each Fisher exact test can be used to generate a volcano plot.
```{r eval=FALSE}
make_volcano_plot(kinase_enrichment_file = 'kinase_enrichment_networkin.csv', 
                  odds_ratio = up_vs_down_odds_ratio,
                  FDR_cutoff = 0.05, 
                  FDR = up_vs_down_FDR,
                  graph_title = "Kinases prediction enrichment (NetworKIN) up vs down",
                  x_axis_title = "log2(odds ratio)",
                  output_folder = "data/",
                  file_name = "up_down_volcano_plot_networkin.pdf")
make_volcano_plot(kinase_enrichment_file = 'kinase_enrichment_networkin.csv', 
                  odds_ratio = up_vs_tot_odds_ratio,
                  FDR_cutoff = 0.05, 
                  FDR = up_vs_tot_FDR,
                  graph_title = "Kinases prediction enrichment (NetworKIN) up vs tot",
                  x_axis_title = "log2(odds ratio)",
                  output_folder = 'data/',
                  file_name = "up_tot_volcano_plot_networkin.pdf")
make_volcano_plot(kinase_enrichment_file = 'kinase_enrichment_networkin.csv', 
                  odds_ratio = down_vs_tot_odds_ratio,
                  FDR_cutoff = 0.05, 
                  FDR = down_vs_tot_FDR,
                  graph_title = "Kinases prediction enrichment (NetworKIN) down vs tot",
                  x_axis_title = "log2(odds ratio)",
                  output_folder = 'data/',
                  file_name = "down_tot_volcano_plot_networkin.pdf")
```

6. Perform IV-KEA
```{r eval=FALSE}
perform_ivkea(clean_phospho_file = 'phospho_clean.csv',
                          invitrodb_file = 'imports/invitrodb.csv',
                          output_folder = 'data/')
```

Run Fisher Exact test
```{r eval=FALSE}
perform_Fisher_exact_test(top_predictions_file = 'ivkea_predictions.csv',
                              predictions = "ivkea",
                              output_folder = 'data/',
                              FC_threshold = 1.2)
```

Plot results on volcano plots
```{r eval=FALSE}
make_volcano_plot(kinase_enrichment_file = 'kinase_enrichment_ivkea.csv', 
                  odds_ratio = up_vs_down_odds_ratio,
                  FDR_cutoff = 0.05, 
                  FDR = up_vs_down_FDR,
                  graph_title = "Kinases prediction enrichment (IV-KEA) up vs down",
                  x_axis_title = "log2(odds ratio)",
                  output_folder = 'data/',
                  file_name = "up_down_volcano_plot_ivkea.pdf")
make_volcano_plot(kinase_enrichment_file = 'kinase_enrichment_ivkea.csv', 
                  odds_ratio = up_vs_tot_odds_ratio,
                  FDR_cutoff = 0.05, 
                  FDR = up_vs_tot_FDR,
                  graph_title = "Kinases prediction enrichment (IV-KEA) up vs tot",
                  x_axis_title = "log2(odds ratio)",
                  output_folder = 'data/',
                  file_name = "up_tot_volcano_plot_ivkea.pdf")
make_volcano_plot(kinase_enrichment_file = 'kinase_enrichment_ivkea.csv', 
                  odds_ratio = down_vs_tot_odds_ratio,
                  FDR_cutoff = 0.05, 
                  FDR = down_vs_tot_FDR,
                  graph_title = "Kinases prediction enrichment (IV-KEA) down vs tot",
                  x_axis_title = "log2(odds ratio)",
                  output_folder = 'data/',
                  file_name = "down_tot_volcano_plot_ivkea.pdf")
```
  
7. Compare enrichment tests from NetworKIN and IV-KEA
```{r}
predictions_comparison(
  ivkea_enrichment_file = 'kinase_enrichment_ivkea.csv',
  networkin_enrichment_file = 'kinase_enrichment_networkin.csv',
  FDR_cutoff = 0.05, 
  graph_title = "Kinases prediction enrichment up vs down networkin vs iv-kea",
  output_folder = 'data/',
  file_name = "comp_plot.pdf"
)
```
